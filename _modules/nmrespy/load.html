

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nmrespy.load &#8212; NMR-EsPy  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NMR-EsPy  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">nmrespy.load</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for nmrespy.load</h1><div class="highlight"><pre>
<span></span><span class="c1"># load.py</span>
<span class="c1"># Simon Hulse</span>
<span class="c1"># simon.hulse@chem.ox.ac.uk</span>

<span class="sd">&quot;&quot;&quot;Provides functionality for importing NMR data.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.fft</span> <span class="kn">import</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">ifftshift</span>

<span class="kn">import</span> <span class="nn">nmrespy._cols</span> <span class="k">as</span> <span class="nn">cols</span>
<span class="k">if</span> <span class="n">cols</span><span class="o">.</span><span class="n">USE_COLORAMA</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">colorama</span>
    <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">nmrespy._errors</span> <span class="k">as</span> <span class="nn">errors</span>
<span class="kn">from</span> <span class="nn">nmrespy._misc</span> <span class="kn">import</span> <span class="n">get_yes_no</span>


<div class="viewcode-block" id="load_bruker"><a class="viewcode-back" href="../../references/load.html#nmrespy.load.load_bruker">[docs]</a><span class="k">def</span> <span class="nf">load_bruker</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">ask_convdta</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads data and relevant parameters from Bruker format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory: str</span>
<span class="sd">        Absolute path to data directory.</span>

<span class="sd">    ask_convdta: bool, optional</span>
<span class="sd">        If `True` (default), the user will be warned that the data should</span>
<span class="sd">        have its digitial filter removed prior to importing if the data to be</span>
<span class="sd">        impoprted is from an `fid` or `ser` file. If `False`, the user is</span>
<span class="sd">        not warned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result: dict</span>
<span class="sd">        A dictionary containing items with the following keys:</span>

<span class="sd">        * `&#39;source&#39;` (str) - The type of data imported (`&#39;bruker_fid&#39;` or</span>
<span class="sd">          `&#39;bruker_pdata&#39;`).</span>
<span class="sd">        * `&#39;data&#39;` (numpy.ndarray) - The data.</span>
<span class="sd">        * `&#39;directory&#39;` (pathlib.Path) - The path to the data directory.</span>
<span class="sd">        * `&#39;sweep_width&#39;` (`[float]` or `[float, float]`) - The experiemnt</span>
<span class="sd">          sweep width in each dimension (Hz).</span>
<span class="sd">        * `&#39;offset&#39;` (`[float]` or `[float, float]`) - The transmitter</span>
<span class="sd">          offset frequency in each dimension (Hz).</span>
<span class="sd">        * `&#39;transmitter_frequency&#39;` (`[float]` or `[float, float]`) - The</span>
<span class="sd">          transmitter frequency in each dimension (MHz).</span>
<span class="sd">        * `&#39;nuclei&#39;` (`[str]` or `[str, str]`) - The nucelus in each</span>
<span class="sd">          dimension.</span>
<span class="sd">        * `&#39;binary_format&#39;` (&#39;str&#39;) - The format of the binary data file.</span>
<span class="sd">          Of the form `&#39;&lt;endian&gt;&lt;unitsize&gt;&#39;`, where `&#39;&lt;endian&gt;&#39;` is either</span>
<span class="sd">          `&#39;&lt;&#39;` (little endian) or `&#39;&gt;&#39;` (big endian), and `&#39;&lt;unitsize&gt;&#39;`</span>
<span class="sd">          is either `&#39;i4&#39;` (32-bit integer) or `&#39;f8&#39;` (64-bit float).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    *Directory Requirements*</span>

<span class="sd">    The path specified by `directory` should</span>
<span class="sd">    contain the following files depending on whether you are importing 1- or</span>
<span class="sd">    2-dimesnional data, and whether you are importing raw FID data or</span>
<span class="sd">    processed data:</span>

<span class="sd">    * 1D data</span>

<span class="sd">      - Raw FID</span>

<span class="sd">        + `directory/fid`</span>
<span class="sd">        + `directory/acqus`</span>

<span class="sd">      - Processed data</span>

<span class="sd">        + `directory/1r`</span>
<span class="sd">        + `directory/acqus`</span>
<span class="sd">        + `directory/procs`</span>


<span class="sd">    * 2D data</span>

<span class="sd">      - Raw FID</span>

<span class="sd">        + `directory/ser`</span>
<span class="sd">        + `directory/acqus`</span>
<span class="sd">        + `directory/acqu2s`</span>

<span class="sd">      - Processed data</span>

<span class="sd">        + `directory/2rr`</span>
<span class="sd">        + `directory/acqus`</span>
<span class="sd">        + `directory/acqu2s`</span>
<span class="sd">        + `directory/procs`</span>
<span class="sd">        + `directory/proc2s`</span>

<span class="sd">    *Digital Filters*</span>

<span class="sd">    If you are importing raw FID data, make sure the path</span>
<span class="sd">    specified corresponds to an `fid` or `ser` file which has had its</span>
<span class="sd">    digital filter removed. To do this, open the data you wish to analyse in</span>
<span class="sd">    TopSpin, and enter `convdta` in the bottom-left command line. You will be</span>
<span class="sd">    prompted to enter a value for the new data directory. It is this value you</span>
<span class="sd">    should use in `directory`, not the one corresponding to the original</span>
<span class="sd">    (uncorrected) signal. There alternative approaches you could take to</span>
<span class="sd">    deal with this. For example, the nmrglue provides the function</span>
<span class="sd">    `nmrglue.fileio.bruker.rm_dig_filter &lt;https://nmrglue.readthedocs.io/en/\</span>
<span class="sd">    latest/reference/generated/nmrglue.fileio.bruker.rm_dig_filter.html#\</span>
<span class="sd">    nmrglue.fileio.bruker.rm_dig_filter&gt;`_</span>

<span class="sd">    **For Development**</span>

<span class="sd">    .. todo::</span>
<span class="sd">       Incorporate functionality to phase correct digitally filtered data.</span>
<span class="sd">       This would circumvent the need to ask the user to ensure they have</span>
<span class="sd">       performed `convdta` prior to importing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Warning text checking that the data being imported has had</span>
    <span class="c1"># |convdta| applied to it.</span>
    <span class="k">if</span> <span class="n">ask_convdta</span><span class="p">:</span>
        <span class="n">convdta_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cols</span><span class="o">.</span><span class="n">OR</span><span class="si">}</span><span class="s1">WARNING: It is necessary that the FID you import has &#39;</span>
            <span class="s1">&#39;been digitally filtered, using the &lt;convdta&gt; command in TopSpin. &#39;</span>
            <span class="s1">&#39;If you have not done this, please do so before proceeding</span><span class="se">\n</span><span class="s1">If &#39;</span>
            <span class="s1">&#39;you wish to proceed, enter [y]</span><span class="se">\n</span><span class="s1">If you wish to quit, enter [n]: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cols</span><span class="o">.</span><span class="n">END</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="p">)</span>

    <span class="c1"># pathlib.Path instance of directory</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="c1"># Check that the directory actually exists...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">cols</span><span class="o">.</span><span class="n">R</span><span class="si">}</span><span class="s1">directory </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1"> doesn</span><span class="se">\&#39;</span><span class="s1">t exist!&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cols</span><span class="o">.</span><span class="n">END</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_file_paths</span><span class="p">(</span><span class="n">path_info</span><span class="p">):</span>
        <span class="c1"># Goes through the entries in path_info and determines whether</span>
        <span class="c1"># the binary file path and and parameter file path(s) in each</span>
        <span class="c1"># entry exist. Returns the path_info entry is all paths are valid.</span>
        <span class="c1"># Retruns None if no entries in path_info are valid.</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">path_info</span><span class="p">:</span>
            <span class="c1"># Check binary file path exists</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="c1"># Check parameter file path(s) exist</span>
                <span class="k">for</span> <span class="n">param_file</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">param_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># At least one parameter file is not found.</span>
                        <span class="c1"># Implies no entries in path_info will be valid.</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="c1"># An entry in path_info has all the requisite files!</span>
                <span class="k">return</span> <span class="n">info</span>
        <span class="c1"># None of the valid binary file names exist in the directory.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Valid combinations of binary file pathname and parameter</span>
    <span class="c1"># file pathname(s)</span>
    <span class="c1"># &#39;bin&#39; - binary file pathname</span>
    <span class="c1"># &#39;param&#39; - parameter file pathname</span>
    <span class="c1"># &#39;dim&#39; - data dimension</span>
    <span class="c1"># &#39;dtype&#39; - type of data (raw FID data or processed data)</span>
    <span class="n">path_info</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># 1D FID</span>
        <span class="p">{</span>
            <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;fid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;acqus&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;acqus&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;fid&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># 2D FID</span>
        <span class="p">{</span>
            <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;ser&#39;</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;acqus&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;acqus&#39;</span><span class="p">,</span>
                <span class="s1">&#39;acqu2s&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;acqu2s&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;fid&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># 1D Processed data</span>
        <span class="p">{</span>
            <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;1r&#39;</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;acqus&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;acqus&#39;</span><span class="p">,</span>
                <span class="s1">&#39;procs&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;procs&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;pdata&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># 2D Processed data</span>
        <span class="p">{</span>
            <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;2rr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;acqus&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;acqus&#39;</span><span class="p">,</span>
                <span class="s1">&#39;acqu2s&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;acqu2s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;procs&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;procs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;proc2s&#39;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;proc2s&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;pdata&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># Either an entry from path_dict or None</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">check_file_paths</span><span class="p">(</span><span class="n">path_info</span><span class="p">)</span>

    <span class="c1"># Required files not present in specified dictionary</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidDirectoryError</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="c1"># If the data to be imported is a raw FID, alert the user about the</span>
    <span class="c1"># necessity to correct for the digital filter</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fid&#39;</span> <span class="ow">and</span> <span class="n">ask_convdta</span><span class="p">:</span>
        <span class="n">get_yes_no</span><span class="p">(</span><span class="n">convdta_prompt</span><span class="p">)</span>

    <span class="c1"># The checks in check_file_paths do not discriminate between</span>
    <span class="c1"># 2D FID data and higher-dimensional FID data. All directories</span>
    <span class="c1"># will have ser, acqus and acqu2s files. Check if there is an</span>
    <span class="c1"># acqu3s file implying the dimension is greater than or equal</span>
    <span class="c1"># to 3.</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fid&#39;</span>
          <span class="ow">and</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="s1">&#39;acqu3s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">MoreThanTwoDimError</span><span class="p">()</span>

    <span class="c1"># --- Search parameter files to get required info --------------------</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pdata&#39;</span><span class="p">:</span>
        <span class="c1"># Processed data - look in procs for binary file structure</span>
        <span class="n">unit_name</span> <span class="o">=</span> <span class="s1">&#39;DTYPP&#39;</span>
        <span class="n">endian_name</span> <span class="o">=</span> <span class="s1">&#39;BYTORDP&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;procs&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># FID data - look in acqus for binary file structure</span>
        <span class="n">unit_name</span> <span class="o">=</span> <span class="s1">&#39;DTYPA&#39;</span>
        <span class="n">endian_name</span> <span class="o">=</span> <span class="s1">&#39;BYTORDA&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;acqus&#39;</span><span class="p">]</span>

    <span class="c1"># Endianess of binary file.</span>
    <span class="c1"># Will be 0 (little endian) or 1 (big endian).</span>
    <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="n">endian_name</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&gt;&#39;</span>
    <span class="c1"># Size of each unit in binary file.</span>
    <span class="c1"># Will be 0 (4-byte integer) or 2 (8-byte float).</span>
    <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;i4&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="n">unit_name</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;f8&#39;</span>
    <span class="c1"># Format to be given to numpy fromfile</span>
    <span class="c1"># &#39;&lt;i4&#39;, &#39;&gt;i4&#39;, &#39;&lt;f8&#39; or &#39;&gt;f8&#39;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">endian</span> <span class="o">+</span> <span class="n">size</span>

    <span class="c1"># Other parameters of interest:</span>
    <span class="c1"># Nucleus, sweep width, transmitter offset, transmitter frequency.</span>
    <span class="n">nuc</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">sfo</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># 1 -&gt; &#39;&#39;, 2 -&gt; &#39;2&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;acqu</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">]</span>

        <span class="c1"># Nucleus is indicated by &lt;1H&gt;, &lt;13C&gt;, etc.</span>
        <span class="n">nuc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;&lt;(.+?)&gt;&#39;</span><span class="p">,</span> <span class="n">_get_param</span><span class="p">(</span><span class="s1">&#39;NUC1&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="s1">&#39;SW_h&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span>
        <span class="n">off</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span>
        <span class="n">sfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="s1">&#39;SFO1&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span>

    <span class="c1"># If data is 2D, need at least one of the dimension sizes in order</span>
    <span class="c1"># to reshape the data after loading from the binary file. Get</span>
    <span class="c1"># indirect dimension size.</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;TD&#39;</span><span class="p">,</span> <span class="s1">&#39;acqu2s&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fid&#39;</span>
                   <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;SI&#39;</span><span class="p">,</span> <span class="s1">&#39;proc2s&#39;</span><span class="p">))</span>
        <span class="n">n_indirect</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_get_param</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="n">file</span><span class="p">]))</span>

    <span class="c1"># --- Import and format binary file data -----------------------------</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fid&#39;</span><span class="p">:</span>
        <span class="c1"># fid and ser files store real and imaginary points consectively</span>
        <span class="c1"># i.e. re - im - re - im - etc.</span>
        <span class="c1"># Convert the data from a length 2N array -&gt; length N array of</span>
        <span class="c1"># complex numbers.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Applying convdta on a 2D signal leads to a block of zeros at</span>
        <span class="c1"># the end of the data, i.e.</span>
        <span class="c1">#</span>
        <span class="c1">#                   ************0000</span>
        <span class="c1">#                   ************0000</span>
        <span class="c1">#                   ************0000</span>
        <span class="c1">#                   ************0000</span>
        <span class="c1">#</span>
        <span class="c1"># This needs to be removed!</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Reshape array</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_indirect</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">n_indirect</span><span class="p">))</span>

            <span class="c1"># # Plots a 3-dimensional wireframe of the data. Used for testing</span>
            <span class="c1"># # purposes. Should see a plane of 0&#39;s right at the end of the</span>
            <span class="c1"># # direct dimension</span>
            <span class="c1"># import matplotlib.pyplot as plt</span>
            <span class="c1"># from mpl_toolkits.mplot3d import Axes3D</span>
            <span class="c1"># fig = plt.figure()</span>
            <span class="c1"># ax = fig.add_subplot(111, projection=&#39;3d&#39;)</span>
            <span class="c1"># x, y = tuple(np.arange(s) for s in data.shape)</span>
            <span class="c1"># xx, yy = tuple(arr.T for arr in np.meshgrid(x, y))</span>
            <span class="c1"># ax.plot_wireframe(xx, yy, data)</span>

            <span class="c1"># Data gets flattened by this operation. Need to reshape it</span>
            <span class="c1"># N.B. I am assuming that no data point is exactly zero other</span>
            <span class="c1"># that those that are expected to be. An error will occur in</span>
            <span class="c1"># reshaping is this is not satisfied. If this is something</span>
            <span class="c1"># that will need to be accounted for, we&#39;ll have to be more</span>
            <span class="c1"># robust</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_indirect</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">n_indirect</span><span class="p">))</span>

            <span class="c1"># # Continuation of testing with plot</span>
            <span class="c1"># x, y = tuple(np.arange(s) for s in data.shape)</span>
            <span class="c1"># xx, yy = tuple(arr.T for arr in np.meshgrid(x, y))</span>
            <span class="c1"># ax.plot_wireframe(xx, yy, data, color=&#39;k&#39;)</span>
            <span class="c1"># print(&#39;bye&#39;)</span>
            <span class="c1"># plt.show()</span>

            <span class="c1"># =================================================</span>
            <span class="c1"># TODO Correctly handle different detection methods</span>
            <span class="c1">#</span>
            <span class="c1"># The crucial value in the parameters files is</span>
            <span class="c1"># FnMODE, which is an integer value</span>
            <span class="c1">#</span>
            <span class="c1"># The folowing schemes are possible:</span>
            <span class="c1">#</span>
            <span class="c1"># 0 -&gt; undefined</span>
            <span class="c1">#</span>
            <span class="c1"># 1 -&gt; QF</span>
            <span class="c1"># Successive fids are acquired with incrementing</span>
            <span class="c1"># time interval without changing the receiver phase.</span>
            <span class="c1">#</span>
            <span class="c1"># 2 -&gt; QSEQ</span>
            <span class="c1"># Successive fids will be acquired with incrementing</span>
            <span class="c1"># time interval and receiver phases 0 and 90 degrees.</span>
            <span class="c1">#</span>
            <span class="c1"># 3 -&gt; TPPI</span>
            <span class="c1"># Successive fids will be acquired with incrementing</span>
            <span class="c1"># time interval and receiver phases 0, 90, 180 and</span>
            <span class="c1"># 270 degrees.</span>
            <span class="c1">#</span>
            <span class="c1"># 4 -&gt; States</span>
            <span class="c1"># Successive fids will be acquired incrementing the</span>
            <span class="c1"># time interval after every second fid and receiver</span>
            <span class="c1"># phases 0 and 90 degrees.</span>
            <span class="c1">#</span>
            <span class="c1"># 5 -&gt; States-TPPI</span>
            <span class="c1"># Successive fids will be acquired incrementing the</span>
            <span class="c1"># time interval after every second fid and receiver</span>
            <span class="c1"># phases 0,90,180 and 270 degrees.cd</span>
            <span class="c1">#</span>
            <span class="c1"># 6 -&gt; Echo-Antiecho</span>
            <span class="c1"># Special phase handling for gradient controlled</span>
            <span class="c1"># experiments.</span>
            <span class="c1">#</span>
            <span class="c1"># See: http://triton.iqfr.csic.es/guide/man/acqref/fnmode.htm</span>
            <span class="c1">#</span>
            <span class="c1"># We will need to figure out how to preprocess each</span>
            <span class="c1"># of these in order to generate correctly formed</span>
            <span class="c1"># time-domain data.</span>
            <span class="c1"># =================================================</span>

    <span class="c1"># Dealing with processed data.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Does the following things:</span>
            <span class="c1"># 1. Flips the spectrum (order frequency bins from low to high</span>
            <span class="c1"># going left to right)</span>
            <span class="c1"># 2. Performs inverse Fourier Transform</span>
            <span class="c1"># 3. Retrieves the first half of the signal, which is a conjugate</span>
            <span class="c1"># symmetric virtual echo</span>
            <span class="c1"># 4. Doubles to reflect loss of imaginary data</span>
            <span class="c1"># 5. Zero fills back to original signal size</span>
            <span class="c1"># 6. Halves the first point to ensure no baseline shift takes</span>
            <span class="c1"># place</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[:</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Reshape data, and flip in both dimensions</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">n_indirect</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">n_indirect</span><span class="p">),</span>
            <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Inverse Fourier Tranform in both dimensions</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
            <span class="c1"># Slice signal in half in both dimensions</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">data</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>

    <span class="c1"># Compile a dictionary of parameters</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;bruker_</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
        <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
        <span class="s1">&#39;sweep_width&#39;</span><span class="p">:</span> <span class="n">sw</span><span class="p">,</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">off</span><span class="p">,</span>
        <span class="s1">&#39;transmitter_frequency&#39;</span><span class="p">:</span> <span class="n">sfo</span><span class="p">,</span>
        <span class="s1">&#39;nuclei&#39;</span><span class="p">:</span> <span class="n">nuc</span><span class="p">,</span>
        <span class="s1">&#39;binary_format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="_get_param"><a class="viewcode-back" href="../../references/load.html#nmrespy.load._get_param">[docs]</a><span class="k">def</span> <span class="nf">_get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve parameter from Bruker acqus or procs file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        The name of the parameter.</span>

<span class="sd">    path: pathlib.Path</span>
<span class="sd">        The path to the parameter file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    param: str</span>
<span class="sd">        The value of the desired parameter as a string.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. warning::</span>
<span class="sd">       This will not work on every parameter found in acqus/procs.</span>
<span class="sd">       Any parameters that are defined over multiple lines will not</span>
<span class="sd">       be correctly returned. There is no need for this in nmrespy (yet),</span>
<span class="sd">       so including this functionality has been neglected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open the parameter file and read in lines</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="c1"># Lines are of the format:</span>
    <span class="c1"># &#39;##$name= param\n&#39;</span>
    <span class="c1"># Search each line for ##$name</span>
    <span class="n">motif</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;##$</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">motif</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">_cat_list</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Concatenates elements of a list to a string&quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">+=</span> <span class="n">string</span>
                    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">string</span>

                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Split line at whitespace and discard first component:</span>
            <span class="c1"># &#39;##$name= param\n&#39; -&gt; &#39;param\n&#39;</span>
            <span class="c1"># Remove trailing newline character:</span>
            <span class="c1"># &#39;param\n&#39; -&gt; &#39;param&#39;</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">_cat_list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># &#39;##$name&#39; was not found in the file</span>
    <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">ParameterNotFoundError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NMR-EsPy  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">nmrespy.load</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Simon Hulse &amp; Mohammadali Foroozandeh.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.2.
    </div>
  </body>
</html>